var agendaApp = angular.module('agendaApp',['ngRoute','ui.bootstrap','smartTable.column','file-model','filereader']);

agendaApp.config(['$httpProvider', function($httpProvider){
		$httpProvider.defaults.useXDomain = true;
		delete $httpProvider.defaults.headers.common['X-Requested-With'];
	}
]);

agendaApp.factory('serverUrl',function(){
        return{
                url: 'http://192.168.10.26:1337'
                // url: 'http://10.25.123.90:1337'
        }
});
agendaApp.factory('socket', function (){
        var socket = io.connect('http://192.168.10.26:1337');
        // var socket = io.connect('http://10.25.123.90:1337');

        return socket;
});
agendaApp.filter('range', function(){
	return function(input, total){
		total = parseInt(total);
		for(var i = 1;i<=total; i++)
			input.push(i);
		return input;
	}
});
agendaApp.config(function($routeProvider){
	$routeProvider.
	when('/',{
		templateUrl: '/views/main.html',
		controller: 'mainController'
	}).
	when('/dashboard/jobView/:idJob',{
		templateUrl: '/views/dashboardJobView.html',
		controller: 'dashboardJobView'
	}).
	when('/add',{
		templateUrl: '/views/add.html',
		controller: 'addController'
	}).
	when('/userManagement',{
		templateUrl: '/views/userManagement.html',
		controller: 'userManagementController'
	}).
	when('/addUser',{
		templateUrl: '/views/addUser.html',
		controller: 'addUserController'
	}).
	when('/addJobCommand',{
		templateUrl: '/views/addJobCommand.html',
		controller: 'addJobCommandController'
	}).
	when('/jobCommand',{
		templateUrl: '/views/jobCommandManagement.html',
		controller: 'jobCommandController'
	}).
	when('/agendaManagement',{
		templateUrl: '/views/agendaManagement.html',
		controller: 'agendaManagement'
	}).
	when('/agendaManagement/view/:idAgenda',{
		templateUrl: '/views/agendaView.html',
		controller: 'agendaView'
	}).
	when('/userManagement/edit/:idUser',{
		templateUrl: '/views/userEdit.html',
		controller: 'userEdit'
	}).
    when('/jobCommand/view/:idCommand',{
        templateUrl: '/views/jobCommandView.html',
        controller: 'jobCommandView'
        }).
    when('/jobCommand/edit/:idCommand',{
    	templateUrl: '/views/jobCommandEdit.html',
    	controller: 'jobCommandEdit'
    })
	;
});

angular.module('agendaApp').controller('mainController', function ($scope, socket, serverUrl, $http){
	$scope.header = "Overview Agenda";
	$scope.message = "Overview Agenda";
	$scope.failed = [];
	$scope.completed = [];
	$scope.progress = [];
    $http.get(serverUrl.url+"/jobCommand",{params: {startPage:1, limitPage:1}}).
        success(function(data, status, headers, config){
            $scope.totalCommand = parseInt(data.total);
        });
    $http.get(serverUrl.url+"/agenda",{params: {startPage:1, limitPage:1}}).
        success(function(data, status, headers, config){
        	$scope.job = parseInt(data[0].total);
        });
    $http.get(serverUrl.url+"/user",{params: {startPage:1, limitPage:1}}).
        success(function(data, status, headers, config){
            $scope.totalUser = parseInt(data.total);
        });
    //get on progress job
    $http.get(serverUrl.url+"/agenda",{params: {status:2}}).
        success(function(data, status, headers, config){
        	$scope.progress = data;
        });

    //get all agenda jobs
    $http.get(serverUrl.url+"/agenda",{params: {startPage:0, limitPage:10, forSection: 'dashboard'}}).
        success(function(data, status, headers, config){
        	$scope.allagenda = data;
        });
    //all waiting agenda
    $http.get(serverUrl.url+"/agenda",{params: {startPage:0, limitPage:10, status: 'waiting'}}).
        success(function(data, status, headers, config){
        	$scope.waitingagenda = data;
        });

    $scope.pageChanged = function(){
		$http.get(serverUrl.url+"/agenda",{params: {startPage:$scope.currentPage, limitPage: 10}}).
		success(function(data, status, headers, config){
			$scope.allagenda = data;
			$scope.totalItems = parseInt(data.total);
			$scope.itemsPerPage = parseInt(10);
		});
	}
	$scope.pageChangedWaitingJob = function(){
		$http.get(serverUrl.url+"/agenda",{params: {status: 'waiting', startPage:$scope.currentPage, limitPage: 10}}).
		success(function(data, status, headers, config){
			$scope.waitingagenda = data;
			$scope.totalItems = parseInt(data.total);
			$scope.itemsPerPage = parseInt(10);
		});
	}

    socket.on('newCommand',function(message){
        var countCommand = parseInt($('.count-command').html());
        countCommand = countCommand + 1;
        $('count-command').html(countCommand);
    });
    socket.on('newUser',function(message){
        var countUser = parseInt($('.count-user').html());
        countUser= countUser + 1;
        $('count-user').html(countUser);
    });
    socket.on('newJob',function(message){
        var countJob = parseInt($('.count-job').html());
        countJob= countJob + 1;
        $('count-job').html(countJob);
        $http.get(serverUrl.url+"/agenda",{params: {startPage:0, limitPage:10, status: 'waiting'}}).
        success(function(data, status, headers, config){
        	$scope.waitingagenda = data;
        });
    });

    socket.on('commandStartExec',function(message){
    	$scope.$apply(function(){
        	$scope.progress.splice(0, 0, message[0]);
        });
    });
    socket.on('commandFailedExec',function(message){
    	$scope.$apply(function(){
        	$scope.failed.splice(0, 0, message[0]);
        	for(var i=0;i<$scope.failed.length;i++){
    			if($scope.failed[i]['_id'] == message[0]._id){
    				$scope.failed.splice(i, 1);
    			}
    		}
        });
    });
    socket.on('commandSuccessExec',function(message){
    	$scope.$apply(function(){
    		for(var i=0;i<$scope.progress.length;i++){
    			if($scope.progress[i]['_id'] == message[0]._id){
    				$scope.progress.splice(i, 1);
    			}
    		}
        	$scope.completed.splice(0, 0, message[0]);
        });
    });
});

angular.module('agendaApp').controller('dashboardJobView',function ($scope, $http, $routeParams, serverUrl) {
    $http.get(serverUrl.url+"/agenda", {params: {id: $routeParams.idJob}}).
        success(function (data, status, headers, config) {
            $scope.job = data;
            $http.get('/upload/'+data["command"]['file']).success(function(data){
		    	$scope.job.fileContent = data;
		    });
        });
});

angular.module('agendaApp').controller('addController', function ($scope, $http, serverUrl, $location){
	$scope.header = "Add New Agenda";
	$scope.message = "Content Add New Agenda";
	$scope.today = function(){
		$scope.dt = new Date();
	};

	$scope.today();
	$scope.clear = function(){
		$scope.dt = null;
	};

	$scope.open = function($event){
		$event.preventDefault();
		$event.stopPropagation();
		$scope.opened = true;
	};

	$scope.min = function($event){
		$event.preventDefault();
		$event.stopPropagation();
		$scope.opened = true;
	};
	$scope.clickCheck = function($val){
		if($val == 1){
			$scope.visible = true;
		}else{
			$scope.visible = false;
		}
		
	};
	$scope.dateOptions = {
		formatYear: 'yy',
		startingDay: 1
	};

	$scope.hstep = 1;
	$scope.mstep = 1;

	$scope.format = 'dd-MMMM-yyyy';
	var d = new Date();
	d.setHours();
	d.setMinutes();
	$scope.job = {
		timeConfig: d
	};
	$http.get(serverUrl.url+"/JobCommand").success(function(data, status, headers, config){
		$scope.datas = data;
	});

	$scope.submit = function($job){
		var a = $job.timeConfig;
		$http.post(serverUrl.url+"/agenda",$job).
		success(function(data, status, headers, config){
			$.notify("Agenda Sukses Ditambahkan","success");
			$location.path("/agendaManagement");
		});
	};
});

angular.module('agendaApp').controller('userManagementController', function ($scope, $http, serverUrl){
	$scope.header = "User Management";
	$scope.message = "User Management";
	// $scope.itemsByPage = 1;
	$http.get(serverUrl.url+"/user",{params: {startPage:1, limitPage: 10}}).
		success(function(data, status, headers, config){
			$scope.data = data.data;
			$scope.totalItems = parseInt(data.total);
			$scope.itemsPerPage = parseInt(10);
		});
	$scope.pageChanged = function(){
		$http.get(serverUrl.url+"/user",{params: {startPage:$scope.currentPage, limitPage: 10}}).
		success(function(data, status, headers, config){
			$scope.data = data;
			$scope.totalItems = parseInt(data.total);
			$scope.itemsPerPage = parseInt(10);
		});
	}
	$scope.delete = function($user){
    	$http.delete(serverUrl.url+"/user",{params: {id: $user.id}}).
    	success(function(data, status, header, config){
    		if(data.status == 'gagal'){
    			$.notify("User "+$user.username+" Gagal Dihapus","error");
    		}else{
    			$.notify("User "+$user.username+" Sukses Dihapus","success");
    			$http.get(serverUrl.url+"/user",{params: {startPage:1, limitPage: 10}}).
				success(function(data, status, headers, config){
					$scope.data = data.data;
					$scope.totalItems = parseInt(data.total);
					$scope.itemsPerPage = parseInt(10);
				});
    		}
    		
    	});
    };

	// $http.get("http://192.168.10.162:1337/user").success(function(data, status, headers, config){
	// 	$scope.datas = data;		
	// });
});

angular.module('agendaApp').controller('addUserController', function ($scope, $http, serverUrl,$location){
	$scope.header = "Add User";
	$scope.message = "Add User";
	$scope.submit = function($job){
		$http.post(serverUrl.url+"/user",$job).
			success(function(data, status, headers, config){
				console.log(data);
				if(data.status == 'gagal'){
					$.notify(data.pesan,"error");
				}else{
					$.notify("User Sukses Ditambahkan","success");
					$location.path("/userManagement");	
				}
				
			});
		};
});

angular.module('agendaApp').controller('addJobCommandController', function ($scope, $http, serverUrl, $location){
	$scope.header = "Add Job Command";
	$scope.message = "Add Job Command";
	$scope.commandShow = 'false';
	$scope.fileShow = 'false';
	$scope.clickCheck = function($inp){
		if($inp == '1'){
			$scope.commandShow = 'true';
			$scope.fileShow = 'false';
		}else{
			$scope.commandShow = 'false';
			$scope.fileShow = 'true'
		}
	};
	$scope.submit = function($job){
		var fd = new FormData();
		if($job.fileCommand){
			fd.append('file',$job.fileCommand);
			$http.post(serverUrl.url+'/jobCommand/uploadFile',fd, {
				transformRequest: angular.identity,
				headers: {'Content-Type': undefined}
			}).success(function(data){
				$job.filename = data.filename;
				$http.post(serverUrl.url+"/jobCommand",$job).
					success(function(data, status, headers, config){
						$.notify("Job Command Sukses Ditambahkan","success");
						$location.path("/jobCommand");
					});
			}).error(function(){
				console.log('error');
			});
		}else{
			$http.post(serverUrl.url+"/jobCommand",$job).
				success(function(data, status, headers, config){
					$.notify("Job Command Sukses Ditambahkan","success");
					$location.path("/jobCommand");
				});
		};
	};
});

angular.module('agendaApp').controller('jobCommandController', function ($scope, $http, serverUrl){
	$scope.header = "Job Command Management";
	$scope.currentPage = 1;
	$http.get(serverUrl.url+"/jobCommand",{params: {startPage:1, limitPage: 10}}).
		success(function(data, status, headers, config){
			$scope.data = data;
			$scope.totalItems = parseInt(data.total);
			$scope.itemsPerPage = parseInt(10);
		});
	$scope.pageChanged = function(){
		$http.get(serverUrl.url+"/jobCommand",{params: {startPage:$scope.currentPage, limitPage: 10}}).
		success(function(data, status, headers, config){
			$scope.data = data;
			$scope.totalItems = parseInt(data.total);
			$scope.itemsPerPage = parseInt(10);
		});
	};
    $scope.delete = function($job){
    	$http.delete(serverUrl.url+"/jobCommand",{params: {id: $job.id}}).
    	success(function(data, status, header, config){
    		if(data.status == 'gagal'){
    			$.notify("Job Command "+$job.name+" Digunakan, Hapus Dulu Job Scheduler Yang Berkaitan","error");
    		}else{
    			$.notify("Job Command "+$job.name+" Sukses Dihapus","success");
    			$http.get(serverUrl.url+"/jobCommand",{params: {startPage:1, limitPage: 10}}).
					success(function(data, status, headers, config){
						$scope.data = data;
						$scope.totalItems = parseInt(data.total);
						$scope.itemsPerPage = parseInt(10);
					});
    		}
    		
    	});
    };
});

angular.module('agendaApp').controller('agendaManagement', function ($scope, $http, serverUrl){
	$scope.header = "Job Schedule Management";
	$scope.currentPage = 1;
	$http.get(serverUrl.url+"/agenda",{params: {startPage:1, limitPage: 10}}).
		success(function(data, status, headers, config){
			$scope.data = data;
			$scope.totalItems = parseInt(data[0].total);
			$scope.itemsPerPage = parseInt(10);
		});
	$scope.pageChanged = function(){
		$http.get(serverUrl.url+"/agenda",{params: {startPage:$scope.currentPage, limitPage: 10}}).
		success(function(data, status, headers, config){
			$scope.data = data;
			$scope.totalItems = parseInt(data[0].total);
			$scope.itemsPerPage = parseInt(10);
		});
	};
	$scope.delete = function($agenda){
    	$http.delete(serverUrl.url+"/agenda",{params: {name: $agenda.name}}).
    	success(function(data, status, header, config){
    		if(data.status == 'gagal'){
    			$.notify("Job "+$agenda.name+" Gagal Dihapus","error");
    		}else{
    			$.notify("Job "+$agenda.name+" Sukses Dihapus","success");
    			$http.get(serverUrl.url+"/agenda",{params: {startPage:1, limitPage: 10}}).
					success(function(data, status, headers, config){
						$scope.data = data;
						$scope.totalItems = parseInt(data[0].total);
						$scope.itemsPerPage = parseInt(10);
					});
    		}
    		
    	});
    };
});

angular.module('agendaApp').controller('agendaView',function ($scope, $http, $routeParams, serverUrl) {
    $http.get(serverUrl.url+"/agenda", {params: {id: $routeParams.idAgenda}}).
        success(function (data, status, headers, config) {
            $scope.job = data;
        });
});

angular.module('agendaApp').controller('userEdit',function ($scope, $http, $routeParams, serverUrl){
	$http.get(serverUrl.url+"/user",{params: {id:$routeParams.idUser}}).
		success(function(data, status, headers, config){
			$scope.job = data[0];
			$scope.job.password = '';
		});
	$scope.submit = function($job){
		$http.put(serverUrl.url+"/user/"+$job.id,$job).
			success(function(data, status, headers, config){
				console.log('kirim sukses');
			});
		};
});
angular.module('agendaApp').controller('jobCommandView',function ($scope, $http, $routeParams, serverUrl) {
    $http.get(serverUrl.url+"/jobCommand", {params: {id: $routeParams.idCommand}}).
        success(function (data, status, headers, config) {
            $scope.job = data[0];
            $http.get('/upload/'+data[0]['file']).success(function(data){
		    	$scope.job.fileContent = data;
		    });
        });
    $scope.submit = function ($job) {
        $http.put(serverUrl.url+"/user/" + $job.id, $job).
            success(function (data, status, headers, config) {
                console.log('kirim sukses');
            });
    };
});
angular.module('agendaApp').controller('jobCommandEdit',function ($scope, $http, $routeParams, serverUrl, FileReader) {
    $http.get(serverUrl.url+"/jobCommand", {params: {id: $routeParams.idCommand}}).
        success(function (data, status, headers, config) {
            $scope.job = data[0];
            $http.get('/upload/'+data[0]['file']).success(function(data){
		    	$scope.job.fileContent = data;
		    });
        });
    
    $scope.submit = function ($job) {
        // $http.put(serverUrl.url+"/user/" + $job.id, $job).
        //     success(function (data, status, headers, config) {
        //         console.log('kirim sukses');
        //     });
    };
});
